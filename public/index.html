<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ãƒ¢ã‚¢è¨ºæ–­ã‚¢ãƒ—ãƒª - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .chat-message {
            animation: fadeInUp 0.5s ease-out;
        }
        
        .option-chip {
            transition: all 0.3s ease;
            animation: slideInFromRight 0.5s ease-out;
        }
        
        .option-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .result-card {
            animation: bounceIn 0.8s ease-out;
        }
        
        .typing-indicator {
            display: inline-block;
            animation: typing 1.5s infinite;
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes typing {
            0%, 20% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .theme-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Landing Page -->
    <div id="landingPage" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gradient-to-r from-purple-600 to-blue-600 text-white">
            <div class="container mx-auto px-4 py-8 text-center">
                <h1 class="text-4xl md:text-6xl font-bold mb-4">
                    <i class="fas fa-laugh-beam mr-3"></i>
                    ãƒ¦ãƒ¼ãƒ¢ã‚¢è¨ºæ–­ã‚¢ãƒ—ãƒª
                </h1>
                <p class="text-xl md:text-2xl mb-6">3åˆ†ã§"ç¬‘ã£ã¦å½“ãŸã‚‹"è¨ºæ–­ä½“é¨“</p>
                <button onclick="scrollToThemes()" class="bg-white text-purple-600 px-8 py-3 rounded-full font-bold text-lg hover:bg-gray-100 transition-colors">
                    è¨ºæ–­ã‚’å§‹ã‚ã‚‹ <i class="fas fa-arrow-down ml-2"></i>
                </button>
            </div>
        </header>

        <!-- Features -->
        <section class="py-16 bg-white">
            <div class="container mx-auto px-4">
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸ£</div>
                        <h3 class="font-bold text-xl mb-2">è»½å¦™ãªãƒ¦ãƒ¼ãƒ¢ã‚¢</h3>
                        <p class="text-gray-600">å®‰å¿ƒã—ã¦ç¬‘ãˆã‚‹ã€ã‚„ã•ã—ã„ãƒ„ãƒƒã‚³ãƒŸã§æ¥½ã—ã„è¨ºæ–­ä½“é¨“</p>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸ’¬</div>
                        <h3 class="font-bold text-xl mb-2">ãƒãƒ£ãƒƒãƒˆå½¢å¼</h3>
                        <p class="text-gray-600">ä¼šè©±ã—ãªãŒã‚‰é€²ã‚€ã€ç›´æ„Ÿçš„ã§ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</p>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸ¯</div>
                        <h3 class="font-bold text-xl mb-2">3åˆ†å®Œçµ</h3>
                        <p class="text-gray-600">ã‚µã‚¯ãƒƒã¨æ¥½ã—ã‚ã¦ã€ã™ãã«ã‚·ã‚§ã‚¢ã§ãã‚‹è»½å¿«ã•</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Theme Selection -->
        <section id="themeSelection" class="py-16 bg-gray-50">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-12">è¨ºæ–­ãƒ†ãƒ¼ãƒã‚’é¸ã‚“ã§ãã ã•ã„</h2>
                <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                    <div class="theme-card bg-white rounded-xl shadow-lg p-6" onclick="startDiagnosis('sushi')">
                        <div class="text-6xl text-center mb-4">ğŸ£</div>
                        <h3 class="text-xl font-bold text-center mb-3">å¯¿å¸ãƒã‚¿è¨ºæ–­</h3>
                        <p class="text-gray-600 text-center">ã‚ãªãŸã®æ€§æ ¼ã‚’å¯¿å¸ãƒã‚¿ã«ä¾‹ãˆã‚‹ã¨ï¼Ÿæœ¬ãƒã‚°ãƒ­ã€ã‚µãƒ¼ãƒ¢ãƒ³ã€ç‰å­...ã©ã®ãƒã‚¿ã«ãªã‚‹ã‹ãªï¼Ÿ</p>
                    </div>
                    <div class="theme-card bg-white rounded-xl shadow-lg p-6" onclick="startDiagnosis('aimodel')">
                        <div class="text-6xl text-center mb-4">ğŸ§ </div>
                        <h3 class="text-xl font-bold text-center mb-3">AIãƒ¢ãƒ‡ãƒ«è¨ºæ–­</h3>
                        <p class="text-gray-600 text-center">ã‚ãªãŸã‚’AIãƒ¢ãƒ‡ãƒ«ã«ä¾‹ãˆã‚‹ã¨ï¼ŸGPTã€BERTã€Diffusion...ã©ã®ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ï¼Ÿ</p>
                    </div>
                    <div class="theme-card bg-white rounded-xl shadow-lg p-6" onclick="startDiagnosis('kansai_tsukkomi')">
                        <div class="text-6xl text-center mb-4">ğŸ¤</div>
                        <h3 class="text-xl font-bold text-center mb-3">é–¢è¥¿ã¤ã£ã“ã¿è¨ºæ–­</h3>
                        <p class="text-gray-600 text-center">ã‚ãªãŸã®ã¤ã£ã“ã¿ã‚¹ã‚¿ã‚¤ãƒ«ã¯ï¼Ÿã€Œã©ãªã„ã‚„ã­ã‚“ã€ã€Œãˆãˆã‚„ã‚“ã‹ã€...ã©ã®ã‚¿ã‚¤ãƒ—ï¼Ÿ</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-8 mt-auto">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; 2025 ãƒ¦ãƒ¼ãƒ¢ã‚¢è¨ºæ–­ã‚¢ãƒ—ãƒª - å¨¯æ¥½ç›®çš„ã®ã‚¸ãƒ§ãƒ¼ã‚¯è¨ºæ–­ã§ã™</p>
            </div>
        </footer>
    </div>

    <!-- Chat Interface -->
    <div id="chatInterface" class="hidden min-h-screen bg-gray-100">
        <!-- Header with Progress -->
        <div class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <button onclick="goHome()" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-arrow-left"></i> ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </button>
                    <div class="flex-1 mx-4">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="progress-bar bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="progressText" class="text-sm text-gray-600">0/4</div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="flex-1 overflow-y-auto pb-20" style="height: calc(100vh - 140px);">
            <div id="chatMessages" class="container mx-auto px-4 py-6 space-y-4"></div>
        </div>

        <!-- Input Area -->
        <div id="optionArea" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
            <div class="container mx-auto">
                <div id="optionButtons" class="flex flex-wrap gap-2 justify-center"></div>
            </div>
        </div>
    </div>

    <!-- Result Card -->
    <div id="resultInterface" class="hidden min-h-screen bg-gray-100 py-8">
        <div class="container mx-auto px-4">
            <div id="resultCard" class="result-card max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                <!-- Result content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Theme data (same as in the original app)
        const themes = {
            sushi: {
                theme_id: "sushi",
                title: "ã‚ãªãŸã‚’å¯¿å¸ãƒã‚¿ã«ä¾‹ãˆã‚‹ã¨ï¼Ÿ",
                humor_style: "witty",
                questions: [
                    {qid: "q1", text: "æœã®ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã¯ï¼Ÿ", type: "choice", options: ["é™ã‹ã«æµ¸ã‚‹", "ã™ãå…¨é–‹", "ã˜ã‚ä¸Šã’"], weight: 1},
                    {qid: "q2", text: "ç· åˆ‡ã¨ã®è·é›¢æ„Ÿ", type: "choice", options: ["å¸¸ã«å…ˆæ‰‹", "å½“æ—¥å‹è² ", "é‹å‘½ã«ä»»ã›ã‚‹"], weight: 2},
                    {qid: "q3", text: "é£²ã¿ä¼šã§ã®ç«‹ã¡å›ã‚Š", type: "choice", options: ["èãå½¹", "ç››ã‚Šä¸Šã’å½¹", "ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹"], weight: 1},
                    {qid: "q4", text: "å¥½ããªé£Ÿæ„Ÿ", type: "choice", options: ["ãƒˆãƒ­ã£ã¨", "ã·ã‚Šã£ã¨", "ãµã‚ã£ã¨"], weight: 1}
                ],
                rules: {
                    map: [
                        {if: {q1: "ã™ãå…¨é–‹", q2: "å½“æ—¥å‹è² "}, type_id: "t_maguro"},
                        {if: {q3: "ç››ã‚Šä¸Šã’å½¹", q4: "ã·ã‚Šã£ã¨"}, type_id: "t_ebi"},
                        {if: {q1: "é™ã‹ã«æµ¸ã‚‹", q3: "èãå½¹"}, type_id: "t_tamago"},
                        {if: {q4: "ãƒˆãƒ­ã£ã¨", q2: "å¸¸ã«å…ˆæ‰‹"}, type_id: "t_maguro"},
                        {if: {q1: "ã˜ã‚ä¸Šã’", q4: "ãµã‚ã£ã¨"}, type_id: "t_salmon"}
                    ],
                    fallback: "t_salmon"
                },
                types: [
                    {type_id: "t_maguro", label: "æœ¬ãƒã‚°ãƒ­", emoji: "ğŸŸ", description: "èŠ¯ãŒå¼·ã„ç¬ç™ºåŠ›ã‚¿ã‚¤ãƒ—"},
                    {type_id: "t_tamago", label: "ç‰å­", emoji: "ğŸ³", description: "ã‚„ã•ã—ã•ã§å ´ã‚’åŒ…ã‚€ç™’ã‚„ã—ç³»"},
                    {type_id: "t_salmon", label: "ã‚µãƒ¼ãƒ¢ãƒ³", emoji: "ğŸ£", description: "ã¿ã‚“ãªå¤§å¥½ãä¸‡èƒ½é¸æ‰‹"},
                    {type_id: "t_ebi", label: "æµ·è€", emoji: "ğŸ¤", description: "å¼¾ã‚€é£Ÿæ„Ÿã®ãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼"}
                ]
            },
            aimodel: {
                theme_id: "aimodel",
                title: "ã‚ãªãŸã‚’AIãƒ¢ãƒ‡ãƒ«ã«ä¾‹ãˆã‚‹ã¨ï¼Ÿ",
                humor_style: "witty",
                questions: [
                    {qid: "q1", text: "ã‚¢ã‚¤ãƒ‡ã‚¢ã®å‡ºã—æ–¹", type: "choice", options: ["ã²ã‚‰ã‚ãä¸€ç™º", "è¨ˆç”»çš„ã«ç©ã‚€", "çŠ¶æ³ã§åˆ‡æ›¿"], weight: 2},
                    {qid: "q2", text: "å‡ºåŠ›ã‚¹ã‚¿ã‚¤ãƒ«", type: "choice", options: ["é•·æ–‡ã§ä¸å¯§ã«", "è¦ç‚¹ã‚’ç®‡æ¡æ›¸ã", "ã‚¤ãƒ¡ãƒ¼ã‚¸ã§èª¬æ˜"], weight: 1},
                    {qid: "q3", text: "åˆå‹•ã¯ï¼Ÿ", type: "choice", options: ["ã¾ãšè©¦ã™", "ã¾ãšèª¿ã¹ã‚‹", "èª°ã‹ã«ç›¸è«‡"], weight: 1},
                    {qid: "q4", text: "å¥½ããªã‚¿ã‚¹ã‚¯", type: "choice", options: ["æ–‡ç« ç”Ÿæˆ", "è¦ç´„ãƒ»æ¤œç´¢", "ç”»åƒãƒã‚¿"], weight: 2}
                ],
                rules: {
                    map: [
                        {if: {q1: "ã²ã‚‰ã‚ãä¸€ç™º", q4: "ç”»åƒãƒã‚¿"}, type_id: "t_diffusion"},
                        {if: {q2: "è¦ç‚¹ã‚’ç®‡æ¡æ›¸ã", q3: "ã¾ãšèª¿ã¹ã‚‹"}, type_id: "t_bert"},
                        {if: {q2: "é•·æ–‡ã§ä¸å¯§ã«", q3: "èª°ã‹ã«ç›¸è«‡"}, type_id: "t_gpt"},
                        {if: {q1: "è¨ˆç”»çš„ã«ç©ã‚€", q4: "è¦ç´„ãƒ»æ¤œç´¢"}, type_id: "t_bert"},
                        {if: {q1: "çŠ¶æ³ã§åˆ‡æ›¿", q2: "ã‚¤ãƒ¡ãƒ¼ã‚¸ã§èª¬æ˜"}, type_id: "t_gpt"}
                    ],
                    fallback: "t_gpt"
                },
                types: [
                    {type_id: "t_gpt", label: "GPT", emoji: "ğŸ§ ", description: "å¤šèŠ¸å¤šæ‰ãªã‚¼ãƒãƒ©ãƒªã‚¹ãƒˆ"},
                    {type_id: "t_bert", label: "BERT", emoji: "ğŸ“š", description: "èª­ã¿è§£ããƒ»è¦ç´„ã®è·äºº"},
                    {type_id: "t_diffusion", label: "Diffusion", emoji: "ğŸ¨", description: "ç™ºæƒ³ã¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã§é­…ã›ã‚‹"},
                    {type_id: "t_rnn", label: "RNN", emoji: "ğŸ”", description: "å‘³ã‚ã„æ·±ã„ä¼çµ±æ´¾"}
                ]
            },
            kansai_tsukkomi: {
                theme_id: "kansai_tsukkomi",
                title: "é–¢è¥¿ã¤ã£ã“ã¿ã‚¿ã‚¤ãƒ—è¨ºæ–­",
                humor_style: "kansai",
                questions: [
                    {qid: "q1", text: "ãƒ„ãƒƒã‚³ãƒŸã®é€Ÿã•", type: "choice", options: ["å³åº§ã«", "ã¡ã‚‡ã„å¾…ã¡", "æ¸©å­˜ã—ã¨ã"], weight: 1},
                    {qid: "q2", text: "ãƒ„ãƒƒã‚³ãƒŸã®æ¸©åº¦", type: "choice", options: ["ã‚„ã•ã—ã‚", "ãã“ãã“", "ãƒ”ãƒªãƒƒã¨"], weight: 2},
                    {qid: "q3", text: "ç›¸æ‰‹ãŒã‚¹ãƒ™ã£ãŸæ™‚", type: "choice", options: ["æ‹¾ã£ã¦ä¼¸ã°ã™", "ä¹—ã£ã‹ã‚‹", "ç©ºæ°—ã‚’å¤‰ãˆã‚‹"], weight: 1},
                    {qid: "q4", text: "å¥½ããªã‚ªãƒ", type: "choice", options: ["ãã‚Œã„ã«ç· ã‚ã‚‹", "ã‚«ã‚ªã‚¹ã§ç¬‘ã†", "ãŸãŸã¿ã‹ã‘ã‚‹"], weight: 1}
                ],
                rules: {
                    map: [
                        {if: {q1: "å³åº§ã«", q2: "ãƒ”ãƒªãƒƒã¨", q4: "ãŸãŸã¿ã‹ã‘ã‚‹"}, type_id: "t_chauyaro"},
                        {if: {q1: "ã¡ã‚‡ã„å¾…ã¡", q2: "ã‚„ã•ã—ã‚", q3: "æ‹¾ã£ã¦ä¼¸ã°ã™"}, type_id: "t_ee_yanka"},
                        {if: {q1: "æ¸©å­˜ã—ã¨ã", q3: "ç©ºæ°—ã‚’å¤‰ãˆã‚‹", q4: "ãã‚Œã„ã«ç· ã‚ã‚‹"}, type_id: "t_moeewa"},
                        {if: {q1: "å³åº§ã«", q2: "ãã“ãã“", q3: "ä¹—ã£ã‹ã‚‹"}, type_id: "t_donaiyanen"}
                    ],
                    fallback: "t_donaiyanen"
                },
                types: [
                    {type_id: "t_donaiyanen", label: "ã©ãªã„ã‚„ã­ã‚“", emoji: "ğŸ¤", description: "ç‹é“ãƒ†ãƒ³ãƒã§å¿ƒåœ°ã‚ˆã"},
                    {type_id: "t_ee_yanka", label: "ãˆãˆã‚„ã‚“ã‹", emoji: "ğŸŒˆ", description: "åŒ…å®¹åŠ›ã§å ´ã‚’ã‚ãŸãŸã‚ã‚‹"},
                    {type_id: "t_chauyaro", label: "ã¡ã‚ƒã†ã‚„ã‚", emoji: "âœ‚ï¸", description: "ã‚­ãƒ¬ã®ã‚ã‚‹ãƒ”ãƒªè¾›ç³»"},
                    {type_id: "t_moeewa", label: "ã‚‚ã†ãˆãˆã‚", emoji: "ğŸ””", description: "ã‚¹ãƒãƒ¼ãƒˆã«ç· ã‚ã‚‹ã¾ã¨ã‚å½¹"}
                ]
            }
        };

        // App state
        let currentTheme = null;
        let currentQuestionIndex = 0;
        let answers = {};
        let stage = 'landing'; // landing, consent, questions, result

        // Utility functions
        function scrollToThemes() {
            document.getElementById('themeSelection').scrollIntoView({ behavior: 'smooth' });
        }

        function startDiagnosis(themeId) {
            currentTheme = themes[themeId];
            currentQuestionIndex = 0;
            answers = {};
            stage = 'consent';
            
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            
            initializeChat();
        }

        function goHome() {
            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('resultInterface').classList.add('hidden');
            document.getElementById('landingPage').classList.remove('hidden');
            
            // Reset state
            currentTheme = null;
            currentQuestionIndex = 0;
            answers = {};
            stage = 'landing';
            
            // Clear chat
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('optionButtons').innerHTML = '';
            updateProgress(0, 0, 4);
        }

        function initializeChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // Greeting
            setTimeout(() => {
                addBotMessage("ã“ã‚“ã«ã¡ã¯ï¼3åˆ†ã§ç¬‘ã£ã¦å¸°ã‚Œã¾ã™ã€‚æº–å‚™OKï¼Ÿ ğŸ˜Š");
                setTimeout(() => {
                    addBotMessage(`ä»Šæ—¥ã¯ã€Œ${currentTheme.title}ã€ã§è¨ºæ–­ã—ã¾ã™ã­ï¼`);
                    setTimeout(() => {
                        showConsentMessage();
                    }, 1000);
                }, 1000);
            }, 500);
        }

        function showConsentMessage() {
            addBotMessage("ã“ã‚Œã¯ã‚¸ãƒ§ãƒ¼ã‚¯ã§ã™ã€‚è¨ºæ–­çµæœã¯å¨¯æ¥½ç›®çš„ã«é™ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
            showOptions(['ã¯ã„ã€æ¥½ã—ã¿ã¾ã™ï¼', 'ã„ã„ãˆ'], ['consent_yes', 'consent_no']);
        }

        function handleOptionClick(optionType, value) {
            addUserMessage(value);
            
            if (optionType === 'consent_yes') {
                stage = 'questions';
                setTimeout(() => {
                    askQuestion();
                }, 1000);
            } else if (optionType === 'consent_no') {
                addBotMessage("ã¾ãŸéŠã³ã«æ¥ã¦ãã ã•ã„ã­ï¼");
                setTimeout(() => {
                    goHome();
                }, 2000);
            } else if (optionType.startsWith('question_')) {
                const questionId = currentTheme.questions[currentQuestionIndex].qid;
                answers[questionId] = value;
                currentQuestionIndex++;
                
                updateProgress(currentQuestionIndex, currentQuestionIndex, currentTheme.questions.length);
                
                if (currentQuestionIndex < currentTheme.questions.length) {
                    setTimeout(() => {
                        askQuestion();
                    }, 1000);
                } else {
                    setTimeout(() => {
                        showResult();
                    }, 1000);
                }
            } else if (optionType === 'restart') {
                currentQuestionIndex = 0;
                answers = {};
                stage = 'questions';
                setTimeout(() => {
                    askQuestion();
                }, 500);
            } else if (optionType === 'new_theme') {
                goHome();
            }
        }

        function askQuestion() {
            if (currentQuestionIndex < currentTheme.questions.length) {
                const question = currentTheme.questions[currentQuestionIndex];
                
                addBotMessage(`${question.text}`);
                
                const optionTypes = question.options.map((_, index) => `question_${currentQuestionIndex}_${index}`);
                showOptions(question.options, optionTypes);
            }
        }

        function showResult() {
            addBotMessage("è¨ºæ–­ä¸­...");
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                const result = generateResult();
                
                document.getElementById('chatInterface').classList.add('hidden');
                document.getElementById('resultInterface').classList.remove('hidden');
                
                displayResultCard(result);
            }, 2000);
        }

        function generateResult() {
            // Determine type based on rules
            const resultType = determineType();
            
            // Generate humor text
            const humorText = generateHumorText(resultType);
            
            return {
                type: resultType,
                title: `ã‚ãªãŸã¯${resultType.label}ã‚¿ã‚¤ãƒ—`,
                summary: humorText,
                one_liner: `${resultType.label}ã£ã½ã„ã‚ãªãŸã€‚${resultType.description}ã§ã€å ´ã‚’æ˜ã‚‹ãã™ã‚‹é­…åŠ›ã®æŒã¡ä¸»ã§ã™ã­ï¼`,
                share_text: `ç§ã¯${resultType.label}ã‚¿ã‚¤ãƒ—ã§ã—ãŸï¼ ${resultType.emoji} #ãƒ¦ãƒ¼ãƒ¢ã‚¢è¨ºæ–­ã‚¢ãƒ—ãƒª`
            };
        }

        function determineType() {
            // Check rules
            for (const rule of currentTheme.rules.map) {
                let matches = true;
                for (const [qid, expectedAnswer] of Object.entries(rule.if)) {
                    if (answers[qid] !== expectedAnswer) {
                        matches = false;
                        break;
                    }
                }
                if (matches) {
                    return currentTheme.types.find(t => t.type_id === rule.type_id);
                }
            }
            
            // Fallback
            return currentTheme.types.find(t => t.type_id === currentTheme.rules.fallback);
        }

        function generateHumorText(type) {
            const humorTemplates = {
                sushi: {
                    t_maguro: "æ±ºã‚ã‚‹æ™‚ã¯ã‚¹ãƒƒã¨å‰ã«å‡ºã‚‹ã‚ãªãŸã€‚æ¿ƒåšã ã‘ã©ã—ã¤ã“ããªã„ã€å ´ã‚’ç· ã‚ã‚‹ä¸»å½¹æ°—è³ªã€‚ã§ã‚‚å®Ÿã¯æ„å¤–ã¨ç¹Šç´°ï¼Ÿ",
                    t_tamago: "ã¿ã‚“ãªã®å¿ƒã‚’ãµã‚“ã‚ã‚ŠåŒ…ã‚€ã‚„ã•ã—ã•ã®å¡Šã€‚ç”˜ãã¦å®‰å¿ƒã§ãã‚‹å­˜åœ¨ã ã‘ã©ã€ãŸã¾ã«ã¯æ„å¤–ãªä¸€é¢ã‚‚è¦‹ã›ã¡ã‚ƒã†ã€‚",
                    t_salmon: "è€è‹¥ç”·å¥³ã«æ„›ã•ã‚Œã‚‹å®‰å®šæ„Ÿã€‚ã‚¯ã‚»ãŒãªãã¦èª°ã¨ã§ã‚‚åˆã‚ã›ã‚‰ã‚Œã‚‹å™¨ç”¨ã•ãŒå…‰ã‚‹ã€‚å®Ÿã¯ã‚³ã‚¹ãƒ‘æœ€å¼·ï¼Ÿ",
                    t_ebi: "ãƒ—ãƒªãƒ—ãƒªã®å¼¾åŠ›ã§å ´ã‚’ç››ã‚Šä¸Šã’ã‚‹ãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼ã€‚ã‚¨ãƒ“åã‚Šã™ã‚‹ã»ã©å…ƒæ°—ã„ã£ã±ã„ï¼"
                },
                aimodel: {
                    t_gpt: "ä½•ã§ã‚‚ãã‚Œãªã‚Šã«ã“ãªã™ä¸‡èƒ½ã‚¿ã‚¤ãƒ—ã€‚ã§ã‚‚æ™‚ã€…æš´èµ°ã—ã¦å¤‰ãªç­”ãˆã‚’å‡ºã—ã¡ã‚ƒã†ã®ãŒã”æ„›å¬Œã€‚",
                    t_bert: "æƒ…å ±ã‚’èª­ã¿è§£ãåŠ›ã¯ãƒ”ã‚«ã‚¤ãƒã€‚ã§ã‚‚æ™‚ã€…ãƒãƒ‹ã‚¢ãƒƒã‚¯ã™ãã¦å‘¨ã‚ŠãŒã¤ã„ã¦ã“ã‚‰ã‚Œãªã„ã‹ã‚‚ï¼Ÿ",
                    t_diffusion: "ç™ºæƒ³åŠ›ãŒè±Šã‹ã§å‰µé€ æ€§æŠœç¾¤ã€‚ã§ã‚‚æ™‚ã€…ç¾å®Ÿé›¢ã‚Œã—ãŸå¤¢ã‚’èªã£ã¡ã‚ƒã†ã®ãŒç‰ã«ã‚­ã‚ºã€‚",
                    t_rnn: "å¤ãè‰¯ãä¼çµ±ã‚’å¤§åˆ‡ã«ã™ã‚‹è·äººæ°—è³ªã€‚æ™‚é–“ã¯ã‹ã‹ã‚‹ã‘ã©ã€ã˜ã£ãã‚Šè€ƒãˆãŸç­”ãˆã¯å‘³ã‚ã„æ·±ã„ã€‚"
                },
                kansai_tsukkomi: {
                    t_donaiyanen: "é–¢è¥¿ã®ç‹é“ã¤ã£ã“ã¿ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ãŸã‚ãªãŸã€‚ãƒ†ãƒ³ãƒã‚ˆãå ´ã‚’ä»•åˆ‡ã‚‹å¸ä¼šè€…ã‚¿ã‚¤ãƒ—ã€‚",
                    t_ee_yanka: "å„ªã—ã•ã‚ãµã‚Œã‚‹ã¤ã£ã“ã¿ã§ã€ç›¸æ‰‹ã‚’å‚·ã¤ã‘ãšã«ç¬‘ã„ã‚’ä½œã‚‹å¹³å’Œä¸»ç¾©è€…ã€‚",
                    t_chauyaro: "ã‚­ãƒ¬å‘³é‹­ã„ã¤ã£ã“ã¿ã§å ´ã‚’å¼•ãç· ã‚ã‚‹ã€‚ã§ã‚‚æ„›æƒ…ãŸã£ã·ã‚Šãªã®ã§æ†ã‚ãªã„ã€‚",
                    t_moeewa: "çš„ç¢ºã«ç· ã‚ããã‚‹ã‚¹ãƒãƒ¼ãƒˆãªã¤ã£ã“ã¿ã€‚ç„¡é§„ãŒãªãã¦ã‚«ãƒƒã‚³ã„ã„å¤§äººã®é­…åŠ›ã€‚"
                }
            };
            
            return humorTemplates[currentTheme.theme_id][type.type_id] || type.description;
        }

        function displayResultCard(result) {
            const resultCard = document.getElementById('resultCard');
            
            resultCard.innerHTML = `
                <div class="bg-gradient-to-br from-purple-500 via-blue-500 to-teal-400 text-white p-8 text-center">
                    <div class="text-6xl mb-4">${result.type.emoji}</div>
                    <h2 class="text-3xl font-bold mb-2">${result.type.label}</h2>
                    <p class="text-lg opacity-90">${result.type.description}</p>
                </div>
                
                <div class="p-8">
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 class="font-bold text-lg mb-3 text-gray-800">è¨ºæ–­çµæœ</h3>
                        <p class="text-gray-700 leading-relaxed">${result.summary}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-share-alt mr-2"></i>çµæœã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ï¼
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <button onclick="shareToX('${result.share_text}')" 
                                    class="bg-black text-white px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors">
                                <i class="fab fa-x-twitter mr-2"></i>X (Twitter)
                            </button>
                            <button onclick="shareToLine('${result.share_text}')" 
                                    class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fab fa-line mr-2"></i>LINE
                            </button>
                            <button onclick="copyToClipboard('${result.share_text}')" 
                                    class="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                                <i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6">
                            <button onclick="restartDiagnosis()" 
                                    class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors">
                                <i class="fas fa-redo mr-2"></i>ã‚‚ã†ä¸€å›
                            </button>
                            <button onclick="goHome()" 
                                    class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-home mr-2"></i>åˆ¥ãƒ†ãƒ¼ãƒã¸
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t text-center text-sm text-gray-500">
                        â€» ã“ã®è¨ºæ–­ã¯å¨¯æ¥½ç›®çš„ã®ã‚¸ãƒ§ãƒ¼ã‚¯ã§ã™
                    </div>
                </div>
            `;
        }

        function restartDiagnosis() {
            document.getElementById('resultInterface').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            
            currentQuestionIndex = 0;
            answers = {};
            stage = 'questions';
            
            document.getElementById('chatMessages').innerHTML = '';
            updateProgress(0, 0, currentTheme.questions.length);
            
            setTimeout(() => {
                addBotMessage("ã‚‚ã†ä¸€åº¦ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼");
                setTimeout(() => {
                    askQuestion();
                }, 1000);
            }, 500);
        }

        // UI helper functions
        function addBotMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex items-start space-x-3';
            messageDiv.innerHTML = `
                <div class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-sm"></i>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 max-w-md">
                    <p class="text-gray-800">${message}</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addUserMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex items-start space-x-3 justify-end';
            messageDiv.innerHTML = `
                <div class="bg-blue-500 text-white rounded-lg shadow-sm p-4 max-w-md">
                    <p>${message}</p>
                </div>
                <div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-user text-sm"></i>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showOptions(options, optionTypes) {
            const optionButtons = document.getElementById('optionButtons');
            optionButtons.innerHTML = '';
            
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-chip bg-white border-2 border-purple-200 hover:border-purple-500 hover:bg-purple-50 px-4 py-2 rounded-full text-sm font-medium transition-all';
                button.textContent = option;
                button.onclick = () => {
                    optionButtons.innerHTML = '';
                    handleOptionClick(optionTypes[index], option);
                };
                
                // Staggered animation
                setTimeout(() => {
                    optionButtons.appendChild(button);
                }, index * 100);
            });
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.id = 'typingIndicator';
            messageDiv.className = 'chat-message flex items-start space-x-3';
            messageDiv.innerHTML = `
                <div class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-sm"></i>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 max-w-md">
                    <div class="flex space-x-1">
                        <div class="typing-indicator bg-gray-400 rounded-full w-2 h-2"></div>
                        <div class="typing-indicator bg-gray-400 rounded-full w-2 h-2" style="animation-delay: 0.2s;"></div>
                        <div class="typing-indicator bg-gray-400 rounded-full w-2 h-2" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function updateProgress(current, completed, total) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            const percentage = (completed / total) * 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${completed}/${total}`;
        }

        // Share functions
        function shareToX(text) {
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function shareToLine(text) {
            const url = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-2"></i>ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                button.classList.add('bg-green-500');
                button.classList.remove('bg-gray-500');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-500');
                    button.classList.add('bg-gray-500');
                }, 2000);
            });
        }
    </script>
</body>
</html>
